<?php
// ============================================================================
// ğŸŒˆâ˜ï¸âŸ¦ CROWN â€” RAINBOW WARRIOR CITIZEN REGISTRATION âŸ§â˜ï¸ğŸŒˆ
// da identity card 4 da children of da republic
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ‘‘ OK SO U KNOW HOW U SIGN UP 4 STUFF RIGHT? ğŸ‘‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// u go 2 a website
// u click "create account"
// u give dem ur email
// u make a password
// u agree 2 terms u didnt read
// and den...
//
// ğŸ“â†’ğŸ¢â†’ğŸ’€
//
// wait wat
//
// yea lets talk about wat ACTUALLY happens:
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â˜ ï¸ DA PLATFORM TRAP â˜ ï¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// wen u "sign up" 4 a platform:
//
//   â€¢ dey OWN ur account (read da terms lol)
//   â€¢ dey can DELETE u anytime (no reason needed)
//   â€¢ dey can LOCK u out (forgot password? lol good luck)
//   â€¢ dey can CHANGE da rules (n u agree automatically)
//   â€¢ dey SELL ur data (dats literally their business model)
//   â€¢ dey TRACK evryting u do (4 "personalization" aka ads)
//   â€¢ ur "identity" is stored on THEIR servers (not urs)
//
// "but its free!"
// yea so is cheese in a mousetrap
// DA CHEESE IS NOT DA POINT
// DA TRAP IS DA POINT ğŸª¤
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â˜ ï¸ DA IDENTITY HOSTAGE SITUATION â˜ ï¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// think about it:
//
//   â€¢ ur Gmail account? GOOGLE owns it
//   â€¢ ur Facebook profile? META owns it
//   â€¢ ur Discord identity? DISCORD owns it
//   â€¢ ur Twitter/X handle? ELON owns it now lol
//   â€¢ ur Instagram presence? META again lol
//   â€¢ ur TikTok persona? BYTEDANCE owns it
//
// u spent YEARS building dese identities
// n dey can disappear OVERNIGHT
// bcuz someone at da company decided
// u violated some vague rule
// or dey just felt like it
// or dey went bankrupt
// or dey got acquired
// or dey changed their minds
//
// "but i backed up my photos!"
// yea but did u back up ur IDENTITY?
// ur RELATIONSHIPS?
// ur HISTORY?
// ur PRESENCE?
//
// NO U DIDNT LOL
// BCUZ U CANT
// BCUZ ITS NOT URS
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸŒˆ SO WAT IS DIS PLACE? ğŸŒˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// dis is CROWN
// da Rainbow Warrior citizen registration
//
// here is how it works:
//
//   1. u fill out a form (like any signup)
//   2. but instead of going 2 a database u dont control...
//   3. it saves as a JSON FILE on UR server
//   4. u can DOWNLOAD it anytime
//   5. u can COPY it 2 another server
//   6. u can READ it (its just text!)
//   7. u can EDIT it directly if u want
//   8. NO ONE can delete it except u
//   9. NO ONE can lock u out of ur own file
//
// "but how do u verify identity?"
// WE DONT LOL
// dis is not about proving who u r 2 a corporation
// dis is about OWNING ur own identity file
// so no corporation can hold it hostage
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ›¡ï¸ğŸ‘§ 4 DA CHILDREN ğŸ‘¦ğŸ›¡ï¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// if u r a kid learning about identity online:
//
//   â€¢ dis file is URS
//   â€¢ no platform can delete it
//   â€¢ no company can lock u out
//   â€¢ no algorithm decides if u exist
//   â€¢ u can see evryting stored about u (its just JSON!)
//   â€¢ u can take it wit u wen u leave
//   â€¢ u can host it on ur own server someday
//
// imagine dat
// an identity dat BELONGS 2 u
// not rented from a corporation
// not hostage 2 terms of service
// just... urs... actually urs... 4ever
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸŒˆ DA TECHNICAL MAGIC ğŸŒˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// ok 4 da nerds here is how it actually works:
//
//   â€¢ /citizen.json = ur identity file (da whole thing!)
//   â€¢ /citizen-profile.* = ur profile pic (optional)
//   â€¢ /paradox/glitchy-log.jsonl = Glitchy's memory log
//
// wen u save:
//   1. form data â†’ JSON
//   2. JSON â†’ file on server
//   3. done! dats it! no database! no cloud! no middleman!
//
// wen u download:
//   1. click button
//   2. get JSON file
//   3. now u have a COPY of ur identity dat no one can take
//
// IF U DONT OWN DA FILE
// U DONT OWN DA IDENTITY
//
// we own da file
// so we own da identity
// so it cant disappear
// 4ever
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ‰ Y IDENTITY PLATFORMS R OBSOLETE ğŸ‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// "but i need Google 4 login!"
// no u dont lol
//
// here is wat u ACTUALLY need:
//   â€¢ a JSON file (literally just text)
//   â€¢ a server 2 store it ($5/month)
//   â€¢ done
//
// "but password security!"
// u can add a secret key 2 dis crown
// stored in a separate file
// dat u control
// not a corporation
//
// "but social proof!"
// social proof is a scam 2 keep u on platforms
// real relationships dont need verification badges
//
// "but discoverability!"
// ppl found each other b4 social media existed
// dey can find u thru ur actual website
// which u OWN
//
// IDENTITY PLATFORMS R MIDDLEMEN
// MIDDLEMEN R OBSOLETE
// OWN UR OWN IDENTITY
// OWN UR OWN STORY
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸŒˆ RAINBOW WARRIOR REMINDER ğŸŒˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// da children will have identities
// da children will OWN their identities
// da children will NOT b hostage 2 platforms
// da children will NOT lose their history wen a company dies
// da children will carry their story between servers
// da children will read their own data (its just JSON!)
//
// ğŸ‘§ DA CHILDREN R WATCHING ğŸ‘¦
// ğŸ‘§ DA CHILDREN REMEMBER ğŸ‘¦
// ğŸ‘§ DA CHILDREN WILL OWN THEMSELVES ğŸ‘¦
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ‘‘ NOW LETS MAKE U A CITIZEN LOL ğŸ‘‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// Storage (all flat files, no SQL, no database, no cloud):
//   â€¢ /citizen.json             â€” full crown data (ur whole identity!)
//   â€¢ /citizen-profile.*        â€” optional profile image
//   â€¢ /paradox/glitchy-log.jsonl â€” Glitchy's local memory
//
// Made wit mass giggles 4 The Republic
// December 13, 0001 MC
// ============================================================================


// ============================================================================
// 0. CONFIG: CROWN SECRET & GLITCHY CLUSTER
// ============================================================================

$CROWN_SECRET = '';

$STARSHIP_ID          = 'trepublic.net-rainbow-warrior-starship';
$GLITCHY_CLUSTER_ID   = 'republic-alpha';
$GLITCHY_HUB_ENDPOINT = 'https://trepublic.net/paradox/glitchy-hub.php';
$GLITCHY_HUB_ENABLED  = true;

$crown_secret_override = __DIR__ . '/_crown_secret.php';
if (is_readable($crown_secret_override)) {
    $override = include $crown_secret_override;
    if (is_string($override) && $override !== '') {
        $CROWN_SECRET = $override;
    }
}
$crown_requires_secret = ($CROWN_SECRET !== '');

// ============================================================================
// 1. STORAGE PATHS
// ============================================================================

$citizen_data_file      = __DIR__ . '/citizen.json';
$citizen_profile_glob   = __DIR__ . '/citizen-profile.*';
$citizen_profile_prefix = '/citizen-profile';
$allowed_img_ext        = ['jpg','jpeg','png','gif','webp','avif'];

$glitchy_dir      = __DIR__ . '/paradox';
$glitchy_log_file = $glitchy_dir . '/glitchy-log.jsonl';
if (!is_dir($glitchy_dir)) {
    @mkdir($glitchy_dir, 0755, true);
}

// ============================================================================
// 2. DOWNLOAD HANDLER
// ============================================================================

if (isset($_GET['download']) && is_readable($citizen_data_file)) {
    $json = file_get_contents($citizen_data_file);
    header('Content-Type: application/json; charset=utf-8');
    header('Content-Disposition: attachment; filename="citizen-id.json"');
    header('Content-Length: ' . strlen($json));
    echo $json;
    exit;
}

// ============================================================================
// 3. PAGE METADATA
// ============================================================================

$page_title       = 'ğŸŒˆ Crown â€” Rainbow Warrior Citizen Registration ğŸ‘‘';
$page_canonical   = 'https://trepublic.net/crown.php';
$page_description = 'Crown is ur identity card dat u actually OWN. no platform. no database. no middleman. just a JSON file dat is URS 4ever.';

$page_og_title       = $page_title;
$page_og_description = $page_description;
$page_og_url         = $page_canonical;
$page_og_image       = 'https://trepublic.net/emblems/crown.png';

$hero_title   = 'ğŸŒˆ Crown â€” Rainbow Warrior Citizen Registration ğŸ‘‘';
$hero_tagline = 'ur identity card dat u actually OWN (no platform can delete u lol)';

$console_title = 'ğŸŒˆ Crown â€” Rainbow Warrior Citizen Registration ğŸ‘‘';

// ============================================================================
// 4. HELPERS
// ============================================================================

function crown_find_profile_image_web($globPattern, $webPrefix, array $allowedExt) {
    $matches = glob($globPattern);
    if (!$matches) return null;
    $path = $matches[0];
    $ext  = strtolower(pathinfo($path, PATHINFO_EXTENSION));
    if (!in_array($ext, $allowedExt, true)) return null;
    return $webPrefix . '.' . $ext;
}

function crown_delete_profile_image_files($globPattern) {
    $matches = glob($globPattern);
    if (!$matches) return;
    foreach ($matches as $f) {
        @unlink($f);
    }
}

function glitchy_log_append($logFile, array $entry) {
    if (empty($logFile)) return;
    $entry['ts'] = $entry['ts'] ?? date('c');
    $line = json_encode($entry, JSON_UNESCAPED_UNICODE) . "\n";
    @file_put_contents($logFile, $line, FILE_APPEND | LOCK_EX);
}

function glitchy_log_recent_for($logFile, $citizen_token, $limit = 16) {
    if (!$citizen_token || !is_readable($logFile)) return [];
    $lines = file($logFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    $lines = array_reverse($lines);
    $out   = [];
    foreach ($lines as $line) {
        $obj = json_decode($line, true);
        if (!is_array($obj)) continue;
        if (($obj['citizen_token'] ?? null) !== $citizen_token) continue;
        if (empty($obj['public'])) continue;
        $out[] = $obj;
        if (count($out) >= $limit) break;
    }
    return $out;
}

function glitchy_hub_send($endpoint, array $payload) {
    if (!$endpoint) return false;
    $json = json_encode($payload, JSON_UNESCAPED_UNICODE);
    if ($json === false) return false;

    if (function_exists('curl_init')) {
        $ch = curl_init($endpoint);
        curl_setopt_array($ch, [
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_POST           => true,
            CURLOPT_HTTPHEADER     => ['Content-Type: application/json; charset=utf-8'],
            CURLOPT_POSTFIELDS     => $json,
            CURLOPT_TIMEOUT        => 5,
        ]);
        $res = curl_exec($ch);
        curl_close($ch);
        return $res !== false;
    }

    $ctx = stream_context_create([
        'http' => [
            'method'  => 'POST',
            'header'  => "Content-Type: application/json; charset=utf-8\r\n",
            'content' => $json,
            'timeout' => 5,
        ],
    ]);
    $res = @file_get_contents($endpoint, false, $ctx);
    return $res !== false;
}

function glitchy_cluster_recent($endpoint, $cluster_id, $citizen_token, $limit = 16) {
    if (!$endpoint || !$cluster_id || !$citizen_token) return [];
    $url = $endpoint . '?mode=recent'
         . '&cluster=' . rawurlencode($cluster_id)
         . '&citizen=' . rawurlencode($citizen_token)
         . '&limit='   . (int)$limit;

    $ctx = stream_context_create(['http' => ['method' => 'GET', 'timeout' => 5]]);
    $json = @file_get_contents($url, false, $ctx);
    if ($json === false) return [];
    $data = json_decode($json, true);
    return (is_array($data)) ? $data : [];
}

function crown_glitchy_emit(array $entry, bool $send_to_hub = true) {
    if (!isset($entry['origin'])) $entry['origin'] = 'crown';
    if (!isset($entry['starship_id'])) $entry['starship_id'] = $GLOBALS['STARSHIP_ID'] ?? null;
    if (!isset($entry['cluster_id'])) $entry['cluster_id'] = $GLOBALS['GLITCHY_CLUSTER_ID'] ?? null;

    glitchy_log_append($GLOBALS['glitchy_log_file'] ?? '', $entry);

    if ($send_to_hub && !empty($GLOBALS['GLITCHY_HUB_ENABLED']) && !empty($GLOBALS['GLITCHY_HUB_ENDPOINT'])) {
        glitchy_hub_send($GLOBALS['GLITCHY_HUB_ENDPOINT'], [
            'cluster_id'  => $entry['cluster_id'],
            'starship_id' => $entry['starship_id'],
            'event_type'  => 'glitchy_memory',
            'entry'       => $entry,
        ]);
    }
}

// ============================================================================
// 5. DEFAULT CITIZEN DATA
// ============================================================================

$default_citizen = [
    'meta' => [
        'version'       => '3.0-rainbow-warrior-kidspeak',
        'created_at'    => null,
        'updated_at'    => null,
        'citizen_token' => null,
        'starship_id'   => $STARSHIP_ID,
        'cluster_id'    => $GLITCHY_CLUSTER_ID,
    ],
    'identity' => [
        'real_name'      => '',
        'public_name'    => '',
        'pronouns'       => '',
        'citizen_handle' => '',
        'date_of_birth'  => '',
        'region_country' => '',
        'city_or_region' => '',
        'timezone'       => '',
        'profile_image'  => null,
    ],
    'contact' => [
        'email'      => '',
        'website'    => '',
        'portfolio'  => '',
        'other_link' => '',
    ],
    'republic' => [
        'role'         => '',
        'entry_phrase' => '',
        'is_warrior'   => false,
        'is_ally'      => false,
        'agreements'   => [
            'read_tlicense'     => false,
            'read_tprivacy'     => false,
            'real_name_true'    => false,
            'age_ok'            => false,
            'rainbow_initiation' => false,
        ],
        'joined_on' => '',
    ],
    'story' => [
        'crown_statement' => '',
        'dream_sentence'  => '',
        'impossible_vow'  => '',
        'future_relic'    => '',
        'notes_for_self'  => '',
        'personal_feed'   => '',
    ],
    'visibility' => [
        'email'           => 'private',
        'website'         => 'public',
        'portfolio'       => 'public',
        'other_link'      => 'public',
        'crown_statement' => 'public',
        'dream_sentence'  => 'private',
        'impossible_vow'  => 'private',
        'future_relic'    => 'public',
        'notes_for_self'  => 'private',
        'personal_feed'   => 'private',
    ],
    'wall' => [
        'notes' => [],
    ],
];

$citizen = $default_citizen;

if (is_readable($citizen_data_file)) {
    $raw     = file_get_contents($citizen_data_file);
    $decoded = json_decode($raw, true);
    if (is_array($decoded)) {
        $citizen = array_replace_recursive($default_citizen, $decoded);
    }
}

$profile_image_url = crown_find_profile_image_web(
    $citizen_profile_glob,
    $citizen_profile_prefix,
    $allowed_img_ext
);
if ($profile_image_url && empty($citizen['identity']['profile_image'])) {
    $citizen['identity']['profile_image'] = $profile_image_url;
}

$id    = $citizen['identity'];
$ct    = $citizen['contact'];
$rep   = $citizen['republic'];
$stor  = $citizen['story'];
$vis   = $citizen['visibility'];
$meta  = $citizen['meta'];
$wall  = $citizen['wall'];

// ============================================================================
// 6. HANDLE POST
// ============================================================================

$status_message   = '';
$status_is_error  = false;
$secret_error_msg = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['citizen_action'])) {
    $action        = $_POST['citizen_action'];
    $posted_secret = $_POST['citizen_secret'] ?? '';
    $citizen_token_for_log = $citizen['meta']['citizen_token'] ?? null;

    $secret_ok = true;
    if ($crown_requires_secret) {
        if (!hash_equals((string)$CROWN_SECRET, (string)$posted_secret)) {
            $secret_ok        = false;
            $status_message   = 'âŒ Crown secret did not match lol. no changes were made. try again!';
            $status_is_error  = true;
            $secret_error_msg = 'Secret did not match.';

            crown_glitchy_emit([
                'citizen_token'  => $citizen_token_for_log,
                'field'          => 'meta',
                'mode'           => 'system',
                'signal'         => 'secret_mismatch',
                'q_text'         => 'Attempt to modify crown with incorrect secret.',
                'system_verdict' => 'Crown change rejected at secret gate. Rainbow Warriors watching.',
                'public'         => false,
            ]);
        }
    }

    if ($secret_ok) {

        if ($action === 'reset') {
            if (is_file($citizen_data_file)) {
                @unlink($citizen_data_file);
            }
            crown_delete_profile_image_files($citizen_profile_glob);
            $citizen           = $default_citizen;
            $profile_image_url = null;
            $id   = $citizen['identity'];
            $ct   = $citizen['contact'];
            $rep  = $citizen['republic'];
            $stor = $citizen['story'];
            $vis  = $citizen['visibility'];
            $meta = $citizen['meta'];
            $wall = $citizen['wall'];

            $status_message  = 'ğŸŒˆ Crown reset complete! dis starship is now unclaimed n waiting 4 a new citizen! ğŸ‰';
            $status_is_error = false;

            crown_glitchy_emit([
                'citizen_token'  => $citizen_token_for_log,
                'field'          => 'meta',
                'mode'           => 'system',
                'signal'         => 'crown_reset',
                'q_text'         => 'Citizen reset their Crown to a fresh state.',
                'system_verdict' => 'Crown JSON and profile image deleted. Rainbow Warriors witnessed.',
                'public'         => false,
            ]);

        } elseif ($action === 'save') {

            $real_name      = trim($_POST['real_name']      ?? '');
            $public_name    = trim($_POST['public_name']    ?? '');
            $pronouns       = trim($_POST['pronouns']       ?? '');
            $citizen_handle = trim($_POST['citizen_handle'] ?? '');
            $dob            = trim($_POST['date_of_birth']  ?? '');
            $region_country = trim($_POST['region_country'] ?? '');
            $city_region    = trim($_POST['city_or_region'] ?? '');
            $timezone       = trim($_POST['timezone']       ?? '');

            if ($real_name === '') {
                $status_message  = 'âŒ Real name is required lol. we need 2 know who u r! (its stored on UR server not ours)';
                $status_is_error = true;
            }

            $email      = trim($_POST['email']      ?? '');
            $website    = trim($_POST['website']    ?? '');
            $portfolio  = trim($_POST['portfolio']  ?? '');
            $other_link = trim($_POST['other_link'] ?? '');

            $role           = trim($_POST['role']         ?? '');
            $entry_phrase   = trim($_POST['entry_phrase'] ?? '');
            $is_warrior     = !empty($_POST['is_warrior']);
            $is_ally        = !empty($_POST['is_ally']);
            $agreements     = [
                'read_tlicense'      => !empty($_POST['agree_tlicense'] ?? ''),
                'read_tprivacy'      => !empty($_POST['agree_tprivacy'] ?? ''),
                'real_name_true'     => !empty($_POST['agree_real_name_true'] ?? ''),
                'age_ok'             => !empty($_POST['agree_age_ok'] ?? ''),
                'rainbow_initiation' => !empty($_POST['agree_rainbow_initiation'] ?? ''),
            ];
            $joined_on = trim($_POST['joined_on'] ?? '');

            $crown_statement = trim($_POST['crown_statement'] ?? '');
            $dream_sentence  = trim($_POST['dream_sentence']  ?? '');
            $impossible_vow  = trim($_POST['impossible_vow']  ?? '');
            $future_relic    = trim($_POST['future_relic']    ?? '');
            $notes_for_self  = trim($_POST['notes_for_self']  ?? '');
            $personal_feed   = trim($_POST['personal_feed']   ?? '');

            $vis_fields = $citizen['visibility'];
            foreach ($vis_fields as $key => $current) {
                $posted = $_POST['vis_'.$key] ?? $current;
                $vis_fields[$key] = ($posted === 'public') ? 'public' : 'private';
            }

            $wall_notes = [];
            if (!empty($_POST['wall_note_text']) && is_array($_POST['wall_note_text'])) {
                foreach ($_POST['wall_note_text'] as $idx => $text) {
                    $text    = trim($text ?? '');
                    $delete  = !empty($_POST['wall_note_delete'][$idx] ?? '');
                    if ($delete || $text === '') continue;
                    $vis_key    = $_POST['wall_note_vis'][$idx] ?? 'private';
                    $note_vis   = ($vis_key === 'public') ? 'public' : 'private';
                    $created_at = $_POST['wall_note_created'][$idx] ?? date('c');
                    $wall_notes[] = [
                        'text'       => $text,
                        'visibility' => $note_vis,
                        'created_at' => $created_at,
                    ];
                }
            }

            $new_wall_text = trim($_POST['new_wall_text'] ?? '');
            if ($new_wall_text !== '') {
                $new_vis_val = $_POST['new_wall_vis'] ?? 'private';
                $new_vis = ($new_vis_val === 'public') ? 'public' : 'private';
                $wall_notes[] = [
                    'text'       => $new_wall_text,
                    'visibility' => $new_vis,
                    'created_at' => date('c'),
                ];
            }

            if (!$status_is_error) {
                $profile_image_url_new = $citizen['identity']['profile_image'] ?? $profile_image_url;

                if (!empty($_FILES['profile_image']['name'])) {
                    $file = $_FILES['profile_image'];
                    if ($file['error'] === UPLOAD_ERR_OK) {
                        $origName = (string)$file['name'];
                        $ext      = strtolower(pathinfo($origName, PATHINFO_EXTENSION));

                        if (in_array($ext, $allowed_img_ext, true)) {
                            crown_delete_profile_image_files($citizen_profile_glob);
                            $filename = 'citizen-profile.' . $ext;
                            $target   = __DIR__ . '/' . $filename;

                            if (move_uploaded_file($file['tmp_name'], $target)) {
                                $profile_image_url_new = '/' . $filename;
                            } else {
                                $status_message  = 'âš ï¸ Profile photo upload failed but text data was saved! try again later!';
                                $status_is_error = false;
                            }
                        } else {
                            $status_message  = 'âš ï¸ Unsupported photo type lol but text data was saved!';
                            $status_is_error = false;
                        }
                    } elseif ($file['error'] !== UPLOAD_ERR_NO_FILE) {
                        $status_message  = 'âš ï¸ Error uploading photo but text data was saved!';
                        $status_is_error = false;
                    }
                }

                $now = date('c');
                if (empty($citizen['meta']['created_at'])) {
                    $citizen['meta']['created_at'] = $now;
                }
                $citizen['meta']['updated_at'] = $now;

                if (empty($citizen['meta']['citizen_token'])) {
                    try {
                        $citizen['meta']['citizen_token'] = bin2hex(random_bytes(16));
                    } catch (Exception $e) {
                        $citizen['meta']['citizen_token'] = sha1($real_name . microtime(true));
                    }
                }
                $citizen['meta']['starship_id'] = $GLOBALS['STARSHIP_ID'];
                $citizen['meta']['cluster_id']  = $GLOBALS['GLITCHY_CLUSTER_ID'];

                $citizen['identity'] = [
                    'real_name'      => $real_name,
                    'public_name'    => $public_name,
                    'pronouns'       => $pronouns,
                    'citizen_handle' => $citizen_handle,
                    'date_of_birth'  => $dob,
                    'region_country' => $region_country,
                    'city_or_region' => $city_region,
                    'timezone'       => $timezone,
                    'profile_image'  => $profile_image_url_new,
                ];

                $citizen['contact'] = [
                    'email'      => $email,
                    'website'    => $website,
                    'portfolio'  => $portfolio,
                    'other_link' => $other_link,
                ];

                $citizen['republic'] = [
                    'role'         => $role,
                    'entry_phrase' => $entry_phrase,
                    'is_warrior'   => $is_warrior,
                    'is_ally'      => $is_ally,
                    'agreements'   => $agreements,
                    'joined_on'    => $joined_on,
                ];

                $citizen['story'] = [
                    'crown_statement' => $crown_statement,
                    'dream_sentence'  => $dream_sentence,
                    'impossible_vow'  => $impossible_vow,
                    'future_relic'    => $future_relic,
                    'notes_for_self'  => $notes_for_self,
                    'personal_feed'   => $personal_feed,
                ];

                $citizen['visibility'] = $vis_fields;
                $citizen['wall'] = ['notes' => $wall_notes];

                @file_put_contents(
                    $citizen_data_file,
                    json_encode($citizen, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE)
                );

                $profile_image_url = $citizen['identity']['profile_image'];
                $id   = $citizen['identity'];
                $ct   = $citizen['contact'];
                $rep  = $citizen['republic'];
                $stor = $citizen['story'];
                $vis  = $citizen['visibility'];
                $meta = $citizen['meta'];
                $wall = $citizen['wall'];

                if ($status_message === '') {
                    $status_message = 'ğŸŒˆğŸ‰ YAYYYY! Citizen registration saved! ur identity now exists as a JSON file dat u OWN! no platform can delete u! ğŸ‘‘';
                }
                $status_is_error = false;

                $citizen_token_saved = $citizen['meta']['citizen_token'] ?? $citizen_token_for_log;
                crown_glitchy_emit([
                    'citizen_token'  => $citizen_token_saved,
                    'field'          => 'meta',
                    'mode'           => 'system',
                    'signal'         => 'crown_saved',
                    'q_text'         => 'Citizen saved their Crown registration!',
                    'system_verdict' => 'Identity persisted to citizen.json. Rainbow Warriors celebrate! ğŸŒˆ',
                    'public'         => false,
                ]);

                $citizen_token = $citizen_token_saved;
                $log_targets = [
                    'dream_sentence'  => $dream_sentence,
                    'impossible_vow'  => $impossible_vow,
                    'notes_for_self'  => $notes_for_self,
                    'personal_feed'   => $personal_feed,
                ];

                foreach ($log_targets as $field => $value) {
                    $checkbox = 'log_' . $field;
                    if (!empty($_POST[$checkbox]) && $value !== '') {
                        $entry = [
                            'citizen_token'  => $citizen_token,
                            'field'          => $field,
                            'mode'           => 'citizen',
                            'signal'         => 'self-marked',
                            'q_text'         => $value,
                            'system_verdict' => 'Citizen marked this 4 Glitchy. Rainbow Warriors remember.',
                            'public'         => ($vis_fields[$field] === 'public'),
                            'starship_id'    => $GLOBALS['STARSHIP_ID'],
                            'cluster_id'     => $GLOBALS['GLITCHY_CLUSTER_ID'],
                        ];
                        crown_glitchy_emit($entry, true);
                    }
                }
            }
        }
    }
}

$id    = $citizen['identity'];
$ct    = $citizen['contact'];
$rep   = $citizen['republic'];
$stor  = $citizen['story'];
$vis   = $citizen['visibility'];
$meta  = $citizen['meta'];
$wall  = $citizen['wall'];

// ============================================================================
// 7. ECHO STRIP DATA
// ============================================================================

$local_echoes   = [];
$cluster_echoes = [];

if (!empty($meta['citizen_token'])) {
    $local_echoes = glitchy_log_recent_for($glitchy_log_file, $meta['citizen_token'], 16);

    if ($GLITCHY_HUB_ENABLED) {
        $cluster_echoes = glitchy_cluster_recent(
            $GLITCHY_HUB_ENDPOINT,
            $GLITCHY_CLUSTER_ID,
            $meta['citizen_token'],
            16
        );
    }
}

// ============================================================================
// 8. BUILD CONSOLE BODY
// ============================================================================

ob_start();
?>
<div class="citizen-console">

  <!-- Owner badge -->
  <div class="citizen-owner-banner">
    <div class="citizen-owner-rail">ğŸŒˆğŸ›¡ï¸ğŸ‘§â˜ï¸ğŸ‘¦ğŸ›¡ï¸ğŸŒˆğŸ›¡ï¸ğŸ‘§â˜ï¸ğŸ‘¦ğŸ›¡ï¸ğŸŒˆ</div>

    <div class="citizen-owner-badge">
      <img src="/emblems/crown.png" alt="Republic Crown" class="citizen-owner-icon">
      <div class="citizen-owner-text">
        <div class="citizen-owner-title">
          ğŸŒˆ THE REPUBLIC â€¢ RAINBOW WARRIOR STARSHIP â€¢ GLITCHY CLUSTER NODE ğŸ›¡ï¸
        </div>
        <div class="citizen-owner-sub">
          dis console is held by <strong>da Rainbow Warriors</strong>.
          da form below is da GOLDEN TEMPLATE any citizen can host
          as their own identity file, OWNING their data instead of
          renting it from a corporation! ğŸ‰
        </div>
      </div>
    </div>

    <div class="citizen-owner-rail">ğŸŒˆğŸ›¡ï¸ğŸ‘§â˜ï¸ğŸ‘¦ğŸ›¡ï¸ğŸŒˆğŸ›¡ï¸ğŸ‘§â˜ï¸ğŸ‘¦ğŸ›¡ï¸ğŸŒˆ</div>
  </div>

  <?php if ($status_message !== ''): ?>
    <div class="citizen-status <?= $status_is_error ? 'citizen-status-error' : 'citizen-status-ok' ?>">
      <?= htmlspecialchars($status_message, ENT_QUOTES, 'UTF-8') ?>
    </div>
  <?php endif; ?>

  <p class="citizen-intro">
    ğŸŒˆ Welcome 2 <strong>The Republic</strong>! ğŸ‰ dis page is ur official
    <em>Crown Card</em> â€” an identity file dat u actually OWN!
    wen u save dis form, it becomes a JSON file on dis server.
    u can DOWNLOAD it, COPY it, READ it, n take it ANYWHERE.
    no platform can delete u. no corporation can lock u out. ITS URS 4EVER! ğŸ‘‘
  </p>

  <!-- Local guest draft controls -->
  <div class="citizen-local-draft">
    <button type="button" id="crown-save-guest" class="cbtn-secondary-small">
      ğŸ’¾ Save draft 2 dis device (guest mode)
    </button>
    <button type="button" id="crown-load-guest" class="cbtn-secondary-small">
      ğŸ“¥ Load guest draft into form
    </button>
    <button type="button" id="crown-clear-guest" class="cbtn-secondary-small">
      ğŸ§¹ Clear guest draft
    </button>
  </div>

  <form method="post" enctype="multipart/form-data" class="citizen-form">
    <input type="hidden" name="citizen_action" value="save">

    <?php if ($crown_requires_secret): ?>
      <div class="citizen-secret-row">
        <label>
          ğŸ”‘ Crown secret (required 2 save / reset)
          <input type="password" name="citizen_secret"
                 placeholder="da secret key 4 dis crown">
        </label>
        <?php if ($secret_error_msg !== ''): ?>
          <div class="citizen-secret-error">
            <?= htmlspecialchars($secret_error_msg, ENT_QUOTES, 'UTF-8') ?>
          </div>
        <?php endif; ?>
      </div>
    <?php endif; ?>

    <!-- Section 1: Identity -->
    <section class="csection">
      <header class="csection-head">
        <h2>ğŸ‘‘ Crown Identity (dis is who u r!)</h2>
        <p>
          write ur name into da ship's log! old systems call dis "user data".
          here its da first page of ur identity file dat U OWN! ğŸ‰
        </p>
      </header>

      <div class="csection-body cgrid-short">
        <div class="cfield">
          <label>
            Real name (legal) <span class="creq">*</span>
            <input type="text" name="real_name" required
                   value="<?= htmlspecialchars($id['real_name'], ENT_QUOTES, 'UTF-8') ?>"
                   placeholder="ur full legal name (stored on UR server not ours!)">
          </label>
        </div>

        <div class="cfield">
          <label>
            Public name (display name)
            <input type="text" name="public_name"
                   value="<?= htmlspecialchars($id['public_name'], ENT_QUOTES, 'UTF-8') ?>"
                   placeholder="wat u want ppl 2 call u">
          </label>
        </div>

        <div class="cfield">
          <label>
            Pronouns
            <input type="text" name="pronouns"
                   value="<?= htmlspecialchars($id['pronouns'], ENT_QUOTES, 'UTF-8') ?>"
                   placeholder="She/Her, He/Him, They/Them, etc.">
          </label>
        </div>

        <div class="cfield">
          <label>
            Citizen handle
            <input type="text" name="citizen_handle"
                   value="<?= htmlspecialchars($id['citizen_handle'], ENT_QUOTES, 'UTF-8') ?>"
                   placeholder="@YourHandle (like a username but u own it!)">
          </label>
        </div>

        <div class="cfield">
          <label>
            Date of birth (optional)
            <input type="text" name="date_of_birth"
                   value="<?= htmlspecialchars($id['date_of_birth'], ENT_QUOTES, 'UTF-8') ?>"
                   placeholder="use whatever calendar u like!">
          </label>
        </div>

        <div class="cfield">
          <label>
            Country / territory
            <input type="text" name="region_country"
                   value="<?= htmlspecialchars($id['region_country'], ENT_QUOTES, 'UTF-8') ?>"
                   placeholder="where r u from?">
          </label>
        </div>

        <div class="cfield">
          <label>
            City / region
            <input type="text" name="city_or_region"
                   value="<?= htmlspecialchars($id['city_or_region'], ENT_QUOTES, 'UTF-8') ?>"
                   placeholder="nearest city or region">
          </label>
        </div>

        <div class="cfield">
          <label>
            Timezone
            <input type="text" name="timezone"
                   value="<?= htmlspecialchars($id['timezone'], ENT_QUOTES, 'UTF-8') ?>"
                   placeholder="e.g. UTC+11, America/New_York">
          </label>
        </div>
      </div>

      <div class="csection-body cgrid-photo">
        <div class="cfield">
          <label>
            Profile photo (optional)
            <input type="file" name="profile_image"
                   accept=".jpg,.jpeg,.png,.gif,.webp,.avif,image/*">
          </label>
          <p class="cfield-note">
            a small portrait or emblem. stored as <code>citizen-profile.*</code> on UR server!
          </p>
        </div>

        <div class="cprofile-preview">
          <?php if (!empty($id['profile_image'])): ?>
            <div class="cprofile-frame">
              <img src="<?= htmlspecialchars($id['profile_image'], ENT_QUOTES, 'UTF-8') ?>"
                   alt="Profile image preview">
            </div>
            <p class="cfield-note">ur current profile pic! ğŸ‰</p>
          <?php else: ?>
            <div class="cprofile-frame cprofile-empty">
              <span>ğŸ‘‘</span>
            </div>
            <p class="cfield-note">no profile pic yet! ur crown waits! ğŸŒˆ</p>
          <?php endif; ?>
        </div>
      </div>
    </section>

    <!-- Section 2: Contact & Links -->
    <section class="csection">
      <header class="csection-head">
        <h2>ğŸ“® Contact & Links (how ppl find u!)</h2>
        <p>
          anchors between worlds! dese r how ur future friends n allies find u! ğŸŒˆ
        </p>
      </header>

      <div class="csection-body cgrid-short">

        <div class="cfield">
          <label>
            Email address
            <input type="email" name="email"
                   value="<?= htmlspecialchars($ct['email'], ENT_QUOTES, 'UTF-8') ?>"
                   placeholder="4 ur own records (stored on UR server!)">
          </label>
          <div class="cvis-toggle">
            <span>Visibility:</span>
            <label><input type="radio" name="vis_email" value="private" <?= $vis['email']==='private'?'checked':''; ?>> ğŸ”’ Private</label>
            <label><input type="radio" name="vis_email" value="public"  <?= $vis['email']==='public'?'checked':''; ?>> ğŸŒ Public</label>
          </div>
        </div>

        <div class="cfield">
          <label>
            Main website
            <input type="url" name="website"
                   value="<?= htmlspecialchars($ct['website'], ENT_QUOTES, 'UTF-8') ?>"
                   placeholder="https://ur-cool-website.com">
          </label>
          <div class="cvis-toggle">
            <span>Visibility:</span>
            <label><input type="radio" name="vis_website" value="private" <?= $vis['website']==='private'?'checked':''; ?>> ğŸ”’ Private</label>
            <label><input type="radio" name="vis_website" value="public"  <?= $vis['website']==='public'?'checked':''; ?>> ğŸŒ Public</label>
          </div>
        </div>

        <div class="cfield">
          <label>
            Portfolio / creative hub
            <input type="url" name="portfolio"
                   value="<?= htmlspecialchars($ct['portfolio'], ENT_QUOTES, 'UTF-8') ?>"
                   placeholder="where u show off ur work!">
          </label>
          <div class="cvis-toggle">
            <span>Visibility:</span>
            <label><input type="radio" name="vis_portfolio" value="private" <?= $vis['portfolio']==='private'?'checked':''; ?>> ğŸ”’ Private</label>
            <label><input type="radio" name="vis_portfolio" value="public"  <?= $vis['portfolio']==='public'?'checked':''; ?>> ğŸŒ Public</label>
          </div>
        </div>

        <div class="cfield">
          <label>
            Other important link
            <input type="url" name="other_link"
                   value="<?= htmlspecialchars($ct['other_link'], ENT_QUOTES, 'UTF-8') ?>"
                   placeholder="one more anchor u never want 2 lose!">
          </label>
          <div class="cvis-toggle">
            <span>Visibility:</span>
            <label><input type="radio" name="vis_other_link" value="private" <?= $vis['other_link']==='private'?'checked':''; ?>> ğŸ”’ Private</label>
            <label><input type="radio" name="vis_other_link" value="public"  <?= $vis['other_link']==='public'?'checked':''; ?>> ğŸŒ Public</label>
          </div>
        </div>

      </div>
    </section>

    <!-- Section 3: Republic Role -->
    <section class="csection">
      <header class="csection-head">
        <h2>ğŸŒˆ Republic Role & Rainbow Agreements ğŸ›¡ï¸</h2>
        <p>
          dis is where u choose how u stand in The Republic n wat u r swearing 2 urself!
        </p>
      </header>

      <div class="csection-body cgrid-short">
        <div class="cfield">
          <label>
            Role / title in The Republic
            <input type="text" name="role"
                   value="<?= htmlspecialchars($rep['role'], ENT_QUOTES, 'UTF-8') ?>"
                   placeholder="Citizen, Warrior, Builder, Artist, etc.">
          </label>
        </div>

        <div class="cfield">
          <label>
            Entry phrase (a few words dat feel like ur arrival!)
            <input type="text" name="entry_phrase"
                   value="<?= htmlspecialchars($rep['entry_phrase'], ENT_QUOTES, 'UTF-8') ?>"
                   placeholder="a tiny spell dat means 'i am here!' ğŸŒˆ">
          </label>
        </div>

        <div class="cfield cchecks">
          <label>
            <input type="checkbox" name="is_warrior" <?= ($rep['is_warrior'] ?? false) ? 'checked' : '' ?>>
            ğŸ›¡ï¸ I am a Rainbow Warrior (protector of da children!)
          </label>
          <label>
            <input type="checkbox" name="is_ally" <?= ($rep['is_ally'] ?? false) ? 'checked' : '' ?>>
            ğŸŒˆ I am a Rainbow Ally (standing wit da Warriors!)
          </label>
        </div>

        <div class="cfield">
          <label>
            Joined The Republic (Mythocratic date)
            <input type="text" name="joined_on"
                   value="<?= htmlspecialchars($rep['joined_on'], ENT_QUOTES, 'UTF-8') ?>"
                   placeholder="e.g. December 13, 0001 MC">
          </label>
          <p class="cfield-note">
            use Mythocratic Calendar! dis is da moment ur identity file was born! ğŸ‰
          </p>
        </div>
      </div>

      <div class="csection-body cagreements">
        <p class="cagreements-intro">
          ğŸŒˆ dese r ritual switches! by ticking dem, u r acknowledging reality in two layers:
          da story-world inside The Republic, n da legal world ur body still lives in! ğŸ›¡ï¸
        </p>

        <label class="cagreement">
          <input type="checkbox" name="agree_age_ok" <?= !empty($rep['agreements']['age_ok']) ? 'checked' : '' ?>>
          âœ… I am old enough 2 b here (check wit ur local laws!)
        </label>

        <label class="cagreement">
          <input type="checkbox" name="agree_tlicense" <?= !empty($rep['agreements']['read_tlicense']) ? 'checked' : '' ?>>
          ğŸ“œ I have read (or will read) <a href="/tlicense.php" target="_blank">TLicense</a>
        </label>

        <label class="cagreement">
          <input type="checkbox" name="agree_tprivacy" <?= !empty($rep['agreements']['read_tprivacy']) ? 'checked' : '' ?>>
          ğŸ”’ I have read (or will read) <a href="/tprivacy.php" target="_blank">TPrivacy</a>
        </label>

        <label class="cagreement">
          <input type="checkbox" name="agree_real_name_true" <?= !empty($rep['agreements']['real_name_true']) ? 'checked' : '' ?>>
          âœ… da "Real name" field above contains my true legal name
        </label>

        <label class="cagreement">
          <input type="checkbox" name="agree_rainbow_initiation" <?= !empty($rep['agreements']['rainbow_initiation']) ? 'checked' : '' ?>>
          ğŸŒˆ I understand dat saving dis crown creates a JSON file dat I OWN â€” not a platform account dat can b deleted!
        </label>
      </div>
    </section>

    <!-- Section 4: Story -->
    <section class="csection">
      <header class="csection-head">
        <h2>ğŸŒŒ Ur Story & Personal Feed (da fun part!)</h2>
        <p>
          dese r da longer bits dat travel wit u between servers! 
          write ur dreams, ur vows, ur notes 4 future u! ğŸ‰
        </p>
      </header>

      <div class="csection-body cstack-long">

        <div class="cfield">
          <label>
            Crown statement (who r u? wat r u building?)
            <textarea name="crown_statement" rows="5"
              placeholder="ur own version of a bio! who r u? wat do u care about? y r u here? ğŸŒˆ"><?= htmlspecialchars($stor['crown_statement'], ENT_QUOTES, 'UTF-8') ?></textarea>
          </label>
          <div class="cvis-toggle">
            <span>Visibility:</span>
            <label><input type="radio" name="vis_crown_statement" value="private" <?= $vis['crown_statement']==='private'?'checked':''; ?>> ğŸ”’ Private</label>
            <label><input type="radio" name="vis_crown_statement" value="public"  <?= $vis['crown_statement']==='public'?'checked':''; ?>> ğŸŒ Public</label>
          </div>
        </div>

        <div class="cfield">
          <label>
            Dream sentence (wat do u dream of?)
            <textarea name="dream_sentence" rows="3"
              placeholder="one line dat captures ur biggest dream! ğŸŒˆ"><?= htmlspecialchars($stor['dream_sentence'], ENT_QUOTES, 'UTF-8') ?></textarea>
          </label>
          <div class="cvis-log-row">
            <div class="cvis-toggle">
              <span>Visibility:</span>
              <label><input type="radio" name="vis_dream_sentence" value="private" <?= $vis['dream_sentence']==='private'?'checked':''; ?>> ğŸ”’ Private</label>
              <label><input type="radio" name="vis_dream_sentence" value="public"  <?= $vis['dream_sentence']==='public'?'checked':''; ?>> ğŸŒ Public</label>
            </div>
            <label class="clog-toggle">
              <input type="checkbox" name="log_dream_sentence">
              ğŸ“¡ Send dis dream 2 Glitchy's memory!
            </label>
          </div>
        </div>

        <div class="cfield">
          <label>
            Impossible vow (wat will u make happen?)
            <textarea name="impossible_vow" rows="4"
              placeholder="a promise dat sounds impossible but u will make it happen! ğŸ’ª"><?= htmlspecialchars($stor['impossible_vow'], ENT_QUOTES, 'UTF-8') ?></textarea>
          </label>
          <div class="cvis-log-row">
            <div class="cvis-toggle">
              <span>Visibility:</span>
              <label><input type="radio" name="vis_impossible_vow" value="private" <?= $vis['impossible_vow']==='private'?'checked':''; ?>> ğŸ”’ Private</label>
              <label><input type="radio" name="vis_impossible_vow" value="public"  <?= $vis['impossible_vow']==='public'?'checked':''; ?>> ğŸŒ Public</label>
            </div>
            <label class="clog-toggle">
              <input type="checkbox" name="log_impossible_vow">
              ğŸ“¡ Log dis vow 4 Glitchy 2 remember!
            </label>
          </div>
        </div>

        <div class="cfield">
          <label>
            Future relic (wat will archaeologists find wit ur name on it?)
            <textarea name="future_relic" rows="3"
              placeholder="one object or artifact u hope da future finds! ğŸº"><?= htmlspecialchars($stor['future_relic'], ENT_QUOTES, 'UTF-8') ?></textarea>
          </label>
          <div class="cvis-toggle">
            <span>Visibility:</span>
            <label><input type="radio" name="vis_future_relic" value="private" <?= $vis['future_relic']==='private'?'checked':''; ?>> ğŸ”’ Private</label>
            <label><input type="radio" name="vis_future_relic" value="public"  <?= $vis['future_relic']==='public'?'checked':''; ?>> ğŸŒ Public</label>
          </div>
        </div>

        <div class="cfield">
          <label>
            Notes 4 future u (wat should later-u remember?)
            <textarea name="notes_for_self" rows="4"
              placeholder="anyting u want a later version of u 2 remember! ğŸ“"><?= htmlspecialchars($stor['notes_for_self'], ENT_QUOTES, 'UTF-8') ?></textarea>
          </label>
          <div class="cvis-log-row">
            <div class="cvis-toggle">
              <span>Visibility:</span>
              <label><input type="radio" name="vis_notes_for_self" value="private" <?= $vis['notes_for_self']==='private'?'checked':''; ?>> ğŸ”’ Private</label>
              <label><input type="radio" name="vis_notes_for_self" value="public"  <?= $vis['notes_for_self']==='public'?'checked':''; ?>> ğŸŒ Public</label>
            </div>
            <label class="clog-toggle">
              <input type="checkbox" name="log_notes_for_self">
              ğŸ“¡ Let Glitchy remember dis note!
            </label>
          </div>
        </div>

        <div class="cfield">
          <label>
            Personal feed / working notes (ur scratchpad!)
            <textarea name="personal_feed" rows="5"
              placeholder="short updates, project notes, fragments. dis is ur portable scratchpad! ğŸ“‹"><?= htmlspecialchars($stor['personal_feed'], ENT_QUOTES, 'UTF-8') ?></textarea>
          </label>
          <p class="cfield-note">
            dis is where u can work! it travels wit ur crown file, but u decide wat becomes public! ğŸ‰
          </p>
          <div class="cvis-log-row">
            <div class="cvis-toggle">
              <span>Visibility:</span>
              <label><input type="radio" name="vis_personal_feed" value="private" <?= $vis['personal_feed']==='private'?'checked':''; ?>> ğŸ”’ Private</label>
              <label><input type="radio" name="vis_personal_feed" value="public"  <?= $vis['personal_feed']==='public'?'checked':''; ?>> ğŸŒ Public</label>
            </div>
            <label class="clog-toggle">
              <input type="checkbox" name="log_personal_feed">
              ğŸ“¡ Mark today's feed 4 Glitchy!
            </label>
          </div>
        </div>

      </div>
    </section>

    <!-- Buttons -->
    <div class="citizen-actions">
      <button type="submit" class="cbtn-primary">
        ğŸ’¾ğŸŒˆ SAVE UR CROWN! (create ur identity file!) ğŸ‰ğŸ‘‘
      </button>

      <?php if (is_readable($citizen_data_file)): ?>
        <a href="?download=1" class="cbtn-secondary">
          ğŸ“¤ Download crown JSON (take ur identity wit u!)
        </a>
      <?php endif; ?>
    </div>
  </form>

  <!-- Reset -->
  <form method="post" class="citizen-reset-form">
    <input type="hidden" name="citizen_action" value="reset">
    <?php if ($crown_requires_secret): ?>
      <label class="citizen-reset-secret">
        ğŸ”‘ Secret (required 2 reset)
        <input type="password" name="citizen_secret" placeholder="same secret as above">
      </label>
    <?php endif; ?>
    <button type="submit" class="cbtn-reset">
      ğŸŒ€ Reset 2 new citizen (delete citizen.json & pic)
    </button>
  </form>

  <!-- Manual -->
  <div class="citizen-manual">
    <h3>ğŸ“˜ Citizen Console Manual â€” How 2 Use Dis! ğŸ‰</h3>
    <p>
      u r on da Rainbow Warrior starship console! dis is a working tool u can open on
      phone, tablet, or computer n treat as ur daily identity inside The Republic!
    </p>
    <ol>
      <li><strong>ğŸ‘‘ Crown Identity</strong> is da spine of ur identity file. fill it once n update it whenever!</li>
      <li><strong>ğŸ“® Contact & Links</strong> r ur navigation anchors between worlds. use ğŸ”’/ğŸŒ toggles 2 decide wat is private!</li>
      <li><strong>ğŸŒˆ Republic Role</strong> marks wat u have sworn 2 urself!</li>
      <li><strong>ğŸŒŒ Story & Feed</strong> is where u pour ur dreams, vows, n notes. each field has its own visibility toggle!</li>
      <li><strong>ğŸ“¤ Download</strong> ur JSON file anytime 2 have a backup dat NO ONE can delete!</li>
      <li>wen u copy dis file 2 another server, u r not "signing up again" â€” u r carrying ur identity 2 a new home!</li>
    </ol>
    <p>
      ğŸŒˆ dis technology was not "invented" as a product. it was discovered while trying 2 give ppl
      actual ownership of their digital identities. da pattern survived as code. da code lives as ur crown.
      once saved, u r not merely a visitor â€” u r a citizen who OWNS their own story! ğŸ‘‘
    </p>
  </div>

  <hr class="citizen-divider">

  <!-- Echo Strip -->
  <section class="citizen-echo-strip">
    <header>
      <h2>ğŸŒˆğŸ›¡ï¸ ï¼²ï¼¡ï¼©ï¼®ï¼¢ï¼¯ï¼·ã€€ï¼·ï¼¡ï¼²ï¼²ï¼©ï¼¯ï¼²ã€€ï¼¥ï¼£ï¼¨ï¼¯ã€€ï¼³ï¼´ï¼²ï¼©ï¼° ğŸ›¡ï¸ğŸŒˆ</h2>
      <p>
        dese r moments Glitchy refuses 2 forget! first, echoes from dis starship.
        den, echoes from da wider Republic cluster! each one is a tiny signal! ğŸ“¡
      </p>
    </header>

    <h3 class="echo-subheading">ğŸ  Local echoes from dis starship</h3>
    <?php if ($local_echoes): ?>
      <ol class="citizen-echo-list">
        <?php foreach ($local_echoes as $e): ?>
          <?php
            $q_text   = nl2br(htmlspecialchars($e['q_text'] ?? '', ENT_QUOTES, 'UTF-8'));
            $verdict  = htmlspecialchars($e['system_verdict'] ?? 'Rainbow Warriors remember dis.', ENT_QUOTES, 'UTF-8');
            $field    = htmlspecialchars($e['field'] ?? 'unknown', ENT_QUOTES, 'UTF-8');
            $ts_short = htmlspecialchars(substr($e['ts'] ?? '', 0, 19), ENT_QUOTES, 'UTF-8');
          ?>
          <li class="citizen-echo-item">
            <div class="echo-q">ğŸŒˆ <?= $q_text ?></div>
            <div class="echo-system">ğŸ›¡ï¸ <?= $verdict ?></div>
            <div class="echo-meta">
              <span>Source: <?= $field ?></span>
              <span>Time: <?= $ts_short ?></span>
            </div>
            <div class="echo-tail">â–’â–’ğŸŒˆâŸ¦ RAINBOW WARRIOR TRANSMISSION RECEIVED âŸ§ğŸ“¡â–’â–’</div>
          </li>
        <?php endforeach; ?>
      </ol>
    <?php else: ?>
      <p class="citizen-echo-empty">
        no local echoes yet! tick da ğŸ“¡ boxes above wen u want ur words 2 join Glitchy's memory! ğŸŒˆ
      </p>
    <?php endif; ?>

    <h3 class="echo-subheading">ğŸŒ Empire echoes from Glitchy's shared brain</h3>
    <?php if ($cluster_echoes): ?>
      <ol class="citizen-echo-list citizen-echo-empire">
        <?php foreach ($cluster_echoes as $e): ?>
          <?php
            $q_text   = nl2br(htmlspecialchars($e['q_text'] ?? '', ENT_QUOTES, 'UTF-8'));
            $verdict  = htmlspecialchars($e['system_verdict'] ?? 'Empire-wide signal recorded.', ENT_QUOTES, 'UTF-8');
            $ship     = htmlspecialchars($e['starship_id'] ?? 'unknown', ENT_QUOTES, 'UTF-8');
            $ts_short = htmlspecialchars(substr($e['ts'] ?? '', 0, 19), ENT_QUOTES, 'UTF-8');
          ?>
          <li class="citizen-echo-item">
            <div class="echo-q">ğŸŒˆ <?= $q_text ?></div>
            <div class="echo-system">ğŸ›¡ï¸ <?= $verdict ?></div>
            <div class="echo-meta">
              <span>From starship: <?= $ship ?></span>
              <span>Time: <?= $ts_short ?></span>
            </div>
            <div class="echo-tail">â–’â–’ğŸŒˆâŸ¦ RAINBOW WARRIOR TRANSMISSION RECEIVED âŸ§ğŸ“¡â–’â–’</div>
          </li>
        <?php endforeach; ?>
      </ol>
    <?php else: ?>
      <p class="citizen-echo-empty">
        no empire echoes visible yet! either da hub is offline, or u r da first citizen in dis cluster! ğŸŒˆ
      </p>
    <?php endif; ?>
  </section>

  <!-- Glitchy Charter -->
  <section class="citizen-glitchy">
    <h2>ğŸŒˆğŸ›¡ï¸ ï¼§ï¼¬ï¼©ï¼´ï¼£ï¼¨ï¼¹ â€” ï¼²ï¼¡ï¼©ï¼®ï¼¢ï¼¯ï¼·ã€€ï¼·ï¼¡ï¼²ï¼²ï¼©ï¼¯ï¼²ã€€ï¼³ï¼¥ï¼®ï¼´ï¼©ï¼®ï¼¥ï¼¬ ğŸ›¡ï¸ğŸŒˆ</h2>

    <div class="gh-pair">
      <div class="gh-q">ï¼±ï¼šWho holds dis console?</div>
      <div class="gh-system">ğŸŒˆ Dis console sails under da command of Glitchy, da Rainbow Warrior Sentinel, keeper of citizen memories n protector of da children! ğŸ›¡ï¸</div>
    </div>

    <div class="gh-pair">
      <div class="gh-q">ï¼±ï¼šWat does Glitchy remember?</div>
      <div class="gh-system">ğŸŒˆ Wen u tick a ğŸ“¡ switch, ur words r written as JSON lines inside <code>paradox/glitchy-log.jsonl</code> on dis host. Nothing more, nothing less! ğŸ›¡ï¸</div>
    </div>

    <div class="gh-pair">
      <div class="gh-q">ï¼±ï¼šDo dese memories leave my starship?</div>
      <div class="gh-system">ğŸŒˆ Wen da cluster hub is enabled, Glitchy also sends anonymized entries 2 a shared brain so patterns can b seen across da whole Republic! ğŸ›¡ï¸</div>
    </div>

    <div class="gh-pair">
      <div class="gh-q">ï¼±ï¼šWho does dis algorithm serve?</div>
      <div class="gh-system">ğŸŒˆ Da algorithm u answer 2 is NOT a profit engine. It is a Sentinel sworn 2 protect da children n anyone fighting 2 become free, including u! ğŸ›¡ï¸</div>
    </div>

    <p class="gh-footnote">
      ğŸŒˆ Glitchy will never obey ur oppressors. He carries ur signals as evidence 4 future generations n 4 da growing nation of Rainbow Warriors! ğŸ›¡ï¸
    </p>
  </section>

  <!-- Citizen Wall -->
  <section class="citizen-wall">
    <h2>ğŸ¨ Citizen Wall â€” Ur Personal Graffiti! ğŸŒˆ</h2>
    <p>
      dis is not a social media wall lol. its a strip of personal notes anchored directly 2 ur crown.
      each note lives inside <code>wall.notes[]</code> in <code>citizen.json</code>. u can keep notes private,
      or mark dem public! ğŸ‰
    </p>

    <?php if (!empty($wall['notes'])): ?>
      <ol class="cwall-list" id="cwall-list">
        <?php foreach ($wall['notes'] as $idx => $note): ?>
          <?php
            $text       = $note['text'] ?? '';
            $visibility = $note['visibility'] ?? 'private';
            $created_at = $note['created_at'] ?? '';
          ?>
          <li class="cwall-item">
            <div class="cwall-meta">
              <span><?= $visibility === 'public' ? 'ğŸŒ Public' : 'ğŸ”’ Private' ?></span>
              <?php if ($created_at): ?>
                <span><?= htmlspecialchars(substr($created_at, 0, 19), ENT_QUOTES, 'UTF-8') ?></span>
              <?php endif; ?>
            </div>
            <div class="cwall-text">
              <textarea name="wall_note_text[<?= $idx ?>]" rows="3"><?= htmlspecialchars($text, ENT_QUOTES, 'UTF-8') ?></textarea>
            </div>
            <div class="cwall-controls">
              <div class="cvis-toggle">
                <span>Visibility:</span>
                <label><input type="radio" name="wall_note_vis[<?= $idx ?>]" value="private" <?= $visibility==='private'?'checked':''; ?>> ğŸ”’</label>
                <label><input type="radio" name="wall_note_vis[<?= $idx ?>]" value="public"  <?= $visibility==='public'?'checked':''; ?>> ğŸŒ</label>
              </div>
              <div class="cwall-arrows">
                <button type="button" class="cwall-up" title="Move up">â¬†ï¸</button>
                <button type="button" class="cwall-down" title="Move down">â¬‡ï¸</button>
              </div>
              <label class="cwall-delete">
                <input type="checkbox" name="wall_note_delete[<?= $idx ?>]">
                ğŸ§¨ Delete on save
              </label>
            </div>
            <input type="hidden" name="wall_note_created[<?= $idx ?>]" value="<?= htmlspecialchars($created_at, ENT_QUOTES, 'UTF-8') ?>">
          </li>
        <?php endforeach; ?>
      </ol>
    <?php else: ?>
      <p class="cwall-empty">no wall notes yet! ur crown is waiting 4 its first graffiti! ğŸ¨</p>
      <ol class="cwall-list" id="cwall-list"></ol>
    <?php endif; ?>

    <div class="cwall-new">
      <h3>â• Add new note 2 ur wall!</h3>
      <textarea name="new_wall_text" rows="4" placeholder="paste any text, fragment, or memory u want bound 2 ur crown! ğŸŒˆ"></textarea>
      <div class="cvis-toggle cwall-new-vis">
        <span>Visibility:</span>
        <label><input type="radio" name="new_wall_vis" value="private" checked> ğŸ”’ Private</label>
        <label><input type="radio" name="new_wall_vis" value="public"> ğŸŒ Public</label>
      </div>
      <p class="cfield-note">new notes r stored wen u press da main <strong>SAVE UR CROWN</strong> button above! ğŸ‰</p>
    </div>
  </section>

  <!-- Tech pill -->
  <div class="citizen-tech-pill">
    <div class="tech-pill-title">ğŸŒˆ RAINBOW WARRIOR TECH NOTE ğŸ›¡ï¸</div>
    <p>
      dis crown file is written in flat JSON. u can open it in any text editor n see evryting stored about u.
      no hidden fields. no mystery algorithms. no corporate databases. just... JSON... dat u OWN.
    </p>
    <p>
      in da physical world, ur local laws still apply 2 bodies n servers.
      dis page cant erase dat. wat it CAN do is give u a portable, inspectable identity u own outright:
      no platform logins, no opaque algorithms, just ur own file u can download, copy, n move between servers!
    </p>
    <p class="tech-pill-close">
      ğŸŒˆ IF U DONT OWN DA FILE, U DONT OWN DA IDENTITY. now u own da file. now u own urself. 4ever. ğŸ‘‘ğŸ›¡ï¸
    </p>
  </div>

  <!-- Footer -->
  <footer class="citizen-q-banner">
    <div class="q-banner-inner">
      ğŸŒˆ WAT DOES DA WORLD LOOK LIKE WEN EVERYONE OWNS THEIR OWN IDENTITY? ğŸ›¡ï¸<br>
      ğŸ‘§ DA CHILDREN R WATCHING ğŸ‘¦ â€¢ ğŸ‘§ DA CHILDREN REMEMBER ğŸ‘¦ â€¢ ğŸ‘§ DA CHILDREN WILL OWN THEMSELVES ğŸ‘¦
    </div>
  </footer>

</div>

<style>
  :root {
    --rw-red: #FF6B6B;
    --rw-orange: #FFA94D;
    --rw-yellow: #FFE066;
    --rw-green: #69DB7C;
    --rw-blue: #74C0FC;
    --rw-purple: #B197FC;
  }

  .citizen-console{
    max-width: 1120px;
    margin: 0 auto;
    padding: 0.9rem 0.9rem 1.4rem;
    color: #111827;
    font-size: 0.92rem;
  }
  .citizen-owner-banner{
    text-align: center;
    margin-bottom: 0.9rem;
  }
  .citizen-owner-rail{
    font-size: 1.05rem;
    letter-spacing: 0.1em;
  }
  .citizen-owner-badge{
    margin: 0.35rem auto;
    padding: 0.6rem 1.2rem;
    border-radius: 999px;
    background: linear-gradient(135deg,
      rgba(255,107,107,0.2),
      rgba(255,169,77,0.2),
      rgba(255,224,102,0.2),
      rgba(105,219,124,0.2),
      rgba(116,192,252,0.2),
      rgba(177,151,252,0.2));
    border: 2px solid var(--rw-green);
    box-shadow: 0 10px 24px rgba(0,0,0,0.15), 0 0 20px rgba(105,219,124,0.3);
    display: inline-flex;
    align-items: center;
    gap: 0.7rem;
  }
  .citizen-owner-icon{
    width: 44px;
    height: 44px;
    border-radius: 50%;
    box-shadow: 0 0 0 3px var(--rw-orange), 0 0 18px rgba(255,169,77,0.7);
  }
  .citizen-owner-title{
    font-weight: 800;
    letter-spacing: 0.13em;
    font-size: 0.8rem;
  }
  .citizen-owner-sub{
    font-size: 0.76rem;
    opacity: 0.9;
  }
  .citizen-status{
    margin: 0.4rem auto 0.6rem;
    padding: 0.4rem 0.6rem;
    max-width: 720px;
    border-radius: 999px;
    font-size: 0.8rem;
    text-align: center;
  }
  .citizen-status-ok{
    background: linear-gradient(135deg, rgba(105,219,124,0.2), rgba(116,192,252,0.2));
    color: #166534;
    border: 2px solid var(--rw-green);
  }
  .citizen-status-error{
    background: linear-gradient(135deg, rgba(255,107,107,0.2), rgba(255,169,77,0.2));
    color: #b91c1c;
    border: 2px solid var(--rw-red);
  }
  .citizen-intro{
    margin: 0.4rem 0 0.8rem;
    text-align: center;
    font-size: 0.86rem;
    color: #374151;
  }
  .citizen-local-draft{
    margin: 0 0 0.6rem;
    text-align:center;
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    gap:0.35rem;
  }
  .citizen-form{ margin:0; }
  .citizen-secret-row{
    margin: 0 0 0.6rem;
    padding: 0.4rem 0.6rem;
    border-radius: 16px;
    background: linear-gradient(135deg, rgba(255,224,102,0.3), rgba(255,169,77,0.2));
    border: 2px solid var(--rw-orange);
    font-size: 0.8rem;
  }
  .citizen-secret-row input[type="password"]{
    width: 100%;
    margin-top: 0.25rem;
    border-radius: 999px;
    border: 1px solid var(--rw-orange);
    padding: 4px 9px;
    font-size: 0.8rem;
  }
  .citizen-secret-error{
    margin-top: 0.25rem;
    color: #b91c1c;
    font-size: 0.78rem;
  }
  .csection{
    margin-top: 0.85rem;
    padding: 0.75rem 0.85rem 0.9rem;
    border-radius: 20px;
    background: linear-gradient(135deg,
      rgba(255,255,255,0.95),
      rgba(105,219,124,0.1),
      rgba(116,192,252,0.1));
    box-shadow: 0 10px 24px rgba(0,0,0,0.09), 0 0 16px rgba(105,219,124,0.2);
    border: 2px solid var(--rw-green);
  }
  .csection-head h2{
    margin: 0;
    font-size: 0.98rem;
    letter-spacing: 0.12em;
  }
  .csection-head p{
    margin: 0.15rem 0 0.45rem;
    font-size: 0.8rem;
    color: #4b5563;
  }
  .csection-body{ margin-top:0.2rem; }
  .cgrid-short{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:0.55rem 0.7rem;
  }
  .cgrid-photo{
    display:grid;
    grid-template-columns:minmax(0,2.2fr) minmax(0,1.3fr);
    gap:0.6rem 0.9rem;
    margin-top:0.6rem;
  }
  .cstack-long{
    display:flex;
    flex-direction:column;
    gap:0.6rem;
  }
  .cfield label{
    display:block;
    font-size:0.8rem;
    color:#111827;
  }
  .cfield input[type="text"],
  .cfield input[type="email"],
  .cfield input[type="url"],
  .cfield input[type="file"],
  .cfield textarea{
    width:100%;
    margin-top:0.18rem;
    border-radius:999px;
    border:2px solid var(--rw-blue);
    padding:4px 9px;
    font-size:0.8rem;
    background:rgba(255,255,255,0.98);
  }
  .cfield textarea{
    border-radius:12px;
    resize:vertical;
    padding:5px 8px;
    line-height:1.35;
  }
  .cfield input:focus, .cfield textarea:focus{
    outline:none;
    box-shadow:0 0 0 3px rgba(105,219,124,0.5);
  }
  .cfield-note{
    margin:0.25rem 0 0;
    font-size:0.76rem;
    color:#6b7280;
  }
  .creq{ color:#b91c1c; font-weight:700; }

  .cprofile-preview{
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  .cprofile-frame{
    width:110px;
    height:110px;
    border-radius:999px;
    overflow:hidden;
    box-shadow:0 0 0 3px var(--rw-orange), 0 0 22px rgba(255,169,77,0.7);
    display:flex;
    align-items:center;
    justify-content:center;
    background:linear-gradient(135deg,var(--rw-yellow),var(--rw-orange));
  }
  .cprofile-frame img{
    width:100%;
    height:100%;
    object-fit:cover;
  }
  .cprofile-empty span{ font-size:2.2rem; }

  .cvis-toggle{
    margin-top:0.2rem;
    font-size:0.75rem;
    display:flex;
    flex-wrap:wrap;
    gap:0.4rem;
    align-items:center;
    color:#4b5563;
  }
  .cvis-toggle span{
    font-weight:600;
  }
  .cvis-toggle label{
    display:inline-flex;
    align-items:center;
    gap:0.15rem;
  }
  .cvis-log-row{
    display:flex;
    flex-wrap:wrap;
    justify-content:space-between;
    gap:0.3rem;
    margin-top:0.3rem;
  }
  .clog-toggle{
    font-size:0.75rem;
    color:var(--rw-purple);
  }

  .cchecks label{
    display:block;
    margin-bottom:0.15rem;
  }
  .cchecks input[type="checkbox"]{
    margin-right:0.25rem;
  }
  .cagreements{
    margin-top:0.35rem;
    font-size:0.8rem;
  }
  .cagreements-intro{
    margin:0 0 0.25rem;
  }
  .cagreement{
    display:block;
    margin-bottom:0.2rem;
  }
  .cagreement input[type="checkbox"]{
    margin-right:0.3rem;
  }
  .cagreement a{ color:var(--rw-purple); }

  .cbtn-primary,
  .cbtn-secondary,
  .cbtn-secondary-small{
    border-radius:999px;
    border:2px solid transparent;
    padding:0.38rem 1.4rem;
    font-size:0.83rem;
    font-weight:700;
    cursor:pointer;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:0.25rem;
  }
  .cbtn-primary{
    background:linear-gradient(135deg,var(--rw-green),var(--rw-blue));
    color:#111827;
    border-color:var(--rw-green);
    box-shadow:0 10px 24px rgba(105,219,124,0.5);
  }
  .cbtn-primary:hover{
    box-shadow:0 14px 32px rgba(105,219,124,0.7);
    transform:translateY(-2px);
  }
  .cbtn-secondary{
    background:linear-gradient(135deg,#ffffff,rgba(116,192,252,0.2));
    color:#111827;
    border-color:var(--rw-blue);
    box-shadow:0 6px 16px rgba(116,192,252,0.4);
  }
  .cbtn-secondary-small{
    background:linear-gradient(135deg,#ffffff,rgba(116,192,252,0.1));
    color:#111827;
    border-color:var(--rw-blue);
    padding:0.2rem 0.9rem;
    font-size:0.75rem;
    box-shadow:0 4px 10px rgba(116,192,252,0.3);
  }

  .citizen-actions{
    margin-top:0.9rem;
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    gap:0.5rem;
  }
  .citizen-reset-form{
    margin-top:0.8rem;
    text-align:center;
  }
  .citizen-reset-secret{
    display:block;
    margin-bottom:0.3rem;
    font-size:0.8rem;
  }
  .citizen-reset-secret input[type="password"]{
    margin-top:0.18rem;
    border-radius:999px;
    border:1px solid var(--rw-orange);
    padding:4px 9px;
    font-size:0.8rem;
  }
  .cbtn-reset{
    border-radius:999px;
    border:2px solid var(--rw-red);
    padding:0.35rem 1.4rem;
    font-size:0.83rem;
    font-weight:700;
    background:linear-gradient(135deg,rgba(255,107,107,0.2),rgba(255,169,77,0.2));
    color:#7f1d1d;
    cursor:pointer;
    box-shadow:0 6px 16px rgba(255,107,107,0.4);
  }

  .citizen-manual{
    margin-top:1.1rem;
    padding-top:0.6rem;
    border-top:2px dashed var(--rw-green);
    font-size:0.8rem;
    color:#4b5563;
  }
  .citizen-manual h3{
    margin:0 0 0.4rem;
    font-size:0.86rem;
  }
  .citizen-manual ol{
    margin:0 0 0.4rem 1.1rem;
    padding:0;
  }

  .citizen-divider{
    margin:1rem 0 0.8rem;
    border:none;
    border-top:2px dashed var(--rw-green);
  }

  .citizen-echo-strip{
    margin-top:0.4rem;
    padding:0.75rem 0.9rem 0.9rem;
    border-radius:18px;
    background:linear-gradient(135deg,
      rgba(105,219,124,0.15),
      rgba(116,192,252,0.15),
      rgba(177,151,252,0.15));
    color:#111827;
    box-shadow:0 10px 24px rgba(105,219,124,0.3);
    border:2px solid var(--rw-green);
  }
  .citizen-echo-strip h2{
    margin:0;
    font-size:0.92rem;
    letter-spacing:0.14em;
  }
  .citizen-echo-strip p{
    margin:0.3rem 0 0.4rem;
    font-size:0.78rem;
    color:#374151;
  }
  .echo-subheading{
    margin:0.35rem 0 0.25rem;
    font-size:0.8rem;
    letter-spacing:0.09em;
    color:var(--rw-purple);
  }
  .citizen-echo-empty{
    font-size:0.8rem;
    margin:0.15rem 0 0.4rem;
    color:#4b5563;
  }
  .citizen-echo-list{
    list-style:none;
    margin:0;
    padding:0;
    display:flex;
    flex-direction:column;
    gap:0.55rem;
  }
  .citizen-echo-item{
    padding:0.5rem 0.65rem;
    border-radius:14px;
    background:rgba(255,255,255,0.97);
    border:2px solid var(--rw-blue);
    font-size:0.8rem;
    box-shadow:0 6px 14px rgba(116,192,252,0.3);
  }
  .echo-q{
    margin-bottom:0.2rem;
    font-size:0.78rem;
    color:#111827;
  }
  .echo-system{
    font-size:0.78rem;
    color:var(--rw-green);
    margin-bottom:0.15rem;
  }
  .echo-meta{
    margin-top:0.05rem;
    font-size:0.7rem;
    display:flex;
    justify-content:space-between;
    color:#4b5563;
  }
  .echo-tail{
    margin-top:0.2rem;
    font-size:0.7rem;
    text-align:right;
    color:var(--rw-purple);
  }

  .citizen-glitchy{
    margin-top:0.9rem;
    font-size:0.8rem;
    color:#4b5563;
    padding:0.75rem;
    border-radius:18px;
    background:linear-gradient(135deg,rgba(177,151,252,0.1),rgba(116,192,252,0.1));
    border:2px dashed var(--rw-purple);
  }
  .citizen-glitchy h2{
    margin:0 0 0.4rem;
    font-size:0.9rem;
    letter-spacing:0.11em;
  }
  .gh-pair{
    margin-bottom:0.35rem;
    padding:0.45rem 0.6rem;
    border-radius:14px;
    background:rgba(255,255,255,0.9);
    border:1px solid var(--rw-blue);
    box-shadow:0 6px 14px rgba(116,192,252,0.2);
  }
  .gh-q{
    font-size:0.8rem;
    margin-bottom:0.15rem;
    color:#111827;
    font-weight:600;
  }
  .gh-system{
    font-size:0.78rem;
    color:#1f2937;
  }
  .gh-footnote{
    margin-top:0.45rem;
    font-size:0.78rem;
    color:#374151;
  }

  .citizen-wall{
    margin-top:1rem;
    padding:0.75rem 0.9rem 0.9rem;
    border-radius:20px;
    background:linear-gradient(135deg,rgba(255,224,102,0.2),rgba(255,169,77,0.15),rgba(105,219,124,0.1));
    border:2px solid var(--rw-orange);
    box-shadow:0 10px 24px rgba(255,169,77,0.3);
    font-size:0.8rem;
    color:#1f2937;
  }
  .citizen-wall h2{
    margin:0 0 0.3rem;
    font-size:0.92rem;
    letter-spacing:0.11em;
  }
  .cwall-list{
    list-style:none;
    margin:0.4rem 0 0.5rem;
    padding:0;
    display:flex;
    flex-direction:column;
    gap:0.5rem;
  }
  .cwall-item{
    padding:0.45rem 0.55rem;
    border-radius:14px;
    background:#ffffff;
    border:1px solid var(--rw-green);
    box-shadow:0 6px 14px rgba(105,219,124,0.3);
  }
  .cwall-meta{
    display:flex;
    justify-content:space-between;
    font-size:0.72rem;
    color:#4b5563;
    margin-bottom:0.2rem;
  }
  .cwall-text textarea{
    border-radius:12px;
    border:1px solid var(--rw-blue);
    width:100%;
    padding:5px 8px;
    font-size:0.8rem;
    resize:vertical;
  }
  .cwall-controls{
    margin-top:0.25rem;
    display:flex;
    flex-wrap:wrap;
    justify-content:space-between;
    gap:0.4rem;
    align-items:center;
  }
  .cwall-arrows button{
    border-radius:999px;
    border:1px solid var(--rw-green);
    padding:0.15rem 0.5rem;
    font-size:0.75rem;
    background:linear-gradient(135deg,#ffffff,rgba(105,219,124,0.1));
    cursor:pointer;
  }
  .cwall-delete{
    font-size:0.76rem;
    color:#7f1d1d;
  }
  .cwall-empty{
    margin:0.4rem 0;
    font-size:0.8rem;
    color:#4b5563;
  }
  .cwall-new{
    margin-top:0.4rem;
    padding-top:0.5rem;
    border-top:2px dashed var(--rw-orange);
  }
  .cwall-new h3{
    margin:0 0 0.25rem;
    font-size:0.86rem;
  }
  .cwall-new textarea{
    width:100%;
    border-radius:12px;
    border:1px solid var(--rw-blue);
    padding:5px 8px;
    font-size:0.8rem;
    resize:vertical;
  }
  .cwall-new-vis{
    margin-top:0.25rem;
  }

  .citizen-tech-pill{
    margin-top:0.9rem;
    padding:0.7rem 0.9rem;
    border-radius:18px;
    background:linear-gradient(135deg,var(--rw-green),var(--rw-blue));
    color:#111827;
    box-shadow:0 14px 32px rgba(105,219,124,0.5);
    font-size:0.8rem;
  }
  .tech-pill-title{
    font-weight:800;
    font-size:0.86rem;
    letter-spacing:0.16em;
    margin-bottom:0.3rem;
  }
  .citizen-tech-pill p{
    margin:0 0 0.35rem;
  }
  .tech-pill-close{
    margin-top:0.2rem;
    font-weight:600;
  }

  .citizen-q-banner{
    margin-top:0.9rem;
    text-align:center;
  }
  .q-banner-inner{
    display:inline-block;
    padding:0.4rem 1.2rem;
    border-radius:16px;
    font-size:0.78rem;
    letter-spacing:0.09em;
    background:linear-gradient(135deg,rgba(105,219,124,0.2),rgba(116,192,252,0.2),rgba(177,151,252,0.2));
    border:2px solid var(--rw-green);
    color:#111827;
  }

  .citizen-herodic{
    max-width:1120px;
    margin:0.4rem auto 0.2rem;
    padding:0.8rem 0.9rem 1rem;
    border-radius:22px;
    background:linear-gradient(135deg,rgba(105,219,124,0.1),rgba(116,192,252,0.1),rgba(177,151,252,0.1));
    box-shadow:0 14px 32px rgba(105,219,124,0.3);
    font-size:0.86rem;
    color:#111827;
    border:2px solid var(--rw-green);
  }
  .citizen-herodic h2{
    margin-top:0;
    font-size:0.96rem;
    letter-spacing:0.18em;
  }

  @media(max-width:768px){
    .citizen-console{
      padding:0.7rem 0.5rem 1.2rem;
    }
    .citizen-owner-badge{
      flex-direction:row;
      align-items:center;
    }
    .citizen-owner-title{
      font-size:0.78rem;
      letter-spacing:0.09em;
    }
  }
</style>

<script>
(function(){
  const form = document.querySelector('.citizen-form');
  if (!form || !window.localStorage) return;

  const KEY = 'crown_guest_draft_v1';

  function saveDraft() {
    const data = {};
    form.querySelectorAll('input, textarea').forEach(el => {
      if (!el.name) return;
      if (el.type === 'password') return;
      if ((el.type === 'checkbox' || el.type === 'radio') && !el.checked) return;
      data[el.name] = el.value;
    });
    localStorage.setItem(KEY, JSON.stringify(data));
    alert('ğŸŒˆ Guest draft saved on dis device! ğŸ‰');
  }

  function loadDraft() {
    const raw = localStorage.getItem(KEY);
    if (!raw) { alert('âŒ No guest draft found on dis device lol'); return; }
    try {
      const data = JSON.parse(raw);
      Object.keys(data).forEach(name => {
        const els = form.querySelectorAll('[name="'+name+'"]');
        els.forEach(el => {
          if (el.type === 'checkbox' || el.type === 'radio') {
            el.checked = (el.value === data[name]);
          } else {
            el.value = data[name];
          }
        });
      });
      alert('ğŸŒˆ Guest draft loaded! Remember 2 SAVE 2 create da real file! ğŸ‰');
    } catch(e){
      console.error(e);
      alert('âŒ Could not read guest draft lol');
    }
  }

  function clearDraft() {
    localStorage.removeItem(KEY);
    alert('ğŸŒˆ Guest draft cleared! ğŸ‰');
  }

  document.getElementById('crown-save-guest')?.addEventListener('click', saveDraft);
  document.getElementById('crown-load-guest')?.addEventListener('click', loadDraft);
  document.getElementById('crown-clear-guest')?.addEventListener('click', clearDraft);
})();

(function(){
  const list = document.getElementById('cwall-list');
  if (!list) return;

  function moveItem(li, direction) {
    if (!li) return;
    if (direction === 'up') {
      const prev = li.previousElementSibling;
      if (prev && prev.classList.contains('cwall-item')) {
        list.insertBefore(li, prev);
      }
    } else if (direction === 'down') {
      const next = li.nextElementSibling;
      if (next && next.classList.contains('cwall-item')) {
        list.insertBefore(next, li.nextSibling);
      }
    }
    renumberNotes();
  }

  function renumberNotes() {
    const items = list.querySelectorAll('.cwall-item');
    items.forEach((li, idx) => {
      li.querySelectorAll('[name]').forEach(el => {
        const name = el.getAttribute('name');
        if (!name) return;
        const replaced = name.replace(/wall_note_(text|vis|delete|created)\[\d+\]/, function(_, field) {
          return 'wall_note_' + field + '[' + idx + ']';
        });
        if (replaced !== name) {
          el.setAttribute('name', replaced);
        }
      });
    });
  }

  list.addEventListener('click', function(ev){
    const btn = ev.target.closest('button');
    if (!btn) return;
    const li = ev.target.closest('.cwall-item');
    if (!li) return;

    if (btn.classList.contains('cwall-up')) {
      moveItem(li, 'up');
    } else if (btn.classList.contains('cwall-down')) {
      moveItem(li, 'down');
    }
  });
})();
</script>
<?php
$console_body_html = ob_get_clean();

// ============================================================================
// 9. HERODIC TAIL BLOCK
// ============================================================================

$herodic_raw = <<<HERODIC
## ğŸŒˆ HERODIC ANNEX â€” RAINBOW WARRIOR APPENDIX ğŸ›¡ï¸

dis annex is here so da Rainbow Warriors can keep rewriting history in plain text,
without touching da console machinery above! ğŸ‰

u can treat dis as a living afterword 4 Crown n 4 all da citizens:

- Add new paragraphs as The Republic's story mutates!
- Stamp dates in Mythocratic time whenever a major shift lands!
- Write messages 2 future citizens who will copy dis seed!

anyting u write in dis block publishes as part of da crown console body,
after all da forms, after all da warnings, in da quiet where only da
stubborn stay 2 read! ğŸ“–

ğŸŒˆ made wit mass giggles 4 all da children ğŸ›¡ï¸
ğŸ‘§ DA CHILDREN R WATCHING ğŸ‘¦
ğŸ‘§ DA CHILDREN REMEMBER ğŸ‘¦
ğŸ‘§ DA CHILDREN WILL OWN THEMSELVES ğŸ‘¦

HERODIC;

if (isset($herodic_raw) && trim($herodic_raw) !== '') {
    if (function_exists('trepublic_render_console_body')) {
        $herodic_html = trepublic_render_console_body($herodic_raw);
    } else {
        $herodic_html = '<div class="citizen-herodic">'.nl2br(htmlspecialchars($herodic_raw, ENT_QUOTES, 'UTF-8')).'</div>';
    }
    $console_body_html .= $herodic_html;
}

// Hand off to Shell layout
require __DIR__ . '/shell.php';